{% extends "base.html" %}
{% block content %}

<!-- Welcome Message for Family Members (only for non-admin users) -->
{% if not user.is_staff %}
<div class="bg-gradient-to-r from-green-50 to-blue-50 border-2 border-green-200 p-4 sm:p-6 rounded-xl shadow-md mb-4 sm:mb-6">
  <div class="flex items-start space-x-3">
    <span class="text-3xl sm:text-4xl">üíö</span>
    <div class="flex-1">
      <h2 class="text-lg sm:text-xl font-bold text-green-800 mb-2" data-lang-en="Welcome to My Financial Journey! üôè" data-lang-kn="‡≤®‡≤®‡≥ç‡≤® ‡≤π‡≤£‡≤ï‡≤æ‡≤∏‡≥Å ‡≤™‡≥ç‡≤∞‡≤Ø‡≤æ‡≤£‡≤ï‡≥ç‡≤ï‡≥Ü ‡≤∏‡≥ç‡≤µ‡≤æ‡≤ó‡≤§! üôè">Welcome to My Financial Journey! üôè</h2>
      <p class="text-sm sm:text-base text-gray-700 leading-relaxed" data-lang-en="Thank you for taking the time to review my expenses. Every transaction here represents my commitment to being transparent and responsible. I'm learning to manage money better every day, and your guidance means the world to me. üòä" data-lang-kn="‡≤®‡≤®‡≥ç‡≤® ‡≤ñ‡≤∞‡≥ç‡≤ö‡≥Å‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤™‡≤∞‡≤ø‡≤∂‡≥Ä‡≤≤‡≤ø‡≤∏‡≤≤‡≥Å ‡≤∏‡≤Æ‡≤Ø ‡≤§‡≥Ü‡≤ó‡≥Ü‡≤¶‡≥Å‡≤ï‡≥ä‡≤Ç‡≤°‡≤ø‡≤¶‡≥ç‡≤¶‡≤ï‡≥ç‡≤ï‡≤æ‡≤ó‡≤ø ‡≤ß‡≤®‡≥ç‡≤Ø‡≤µ‡≤æ‡≤¶‡≤ó‡≤≥‡≥Å. ‡≤á‡≤≤‡≥ç‡≤≤‡≤ø‡≤® ‡≤™‡≥ç‡≤∞‡≤§‡≤ø‡≤Ø‡≥ä‡≤Ç‡≤¶‡≥Å ‡≤µ‡≤π‡≤ø‡≤µ‡≤æ‡≤ü‡≥Å ‡≤™‡≤æ‡≤∞‡≤¶‡≤∞‡≥ç‡≤∂‡≤ï ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤ú‡≤µ‡≤æ‡≤¨‡≥ç‡≤¶‡≤æ‡≤∞‡≤ø‡≤Ø‡≥Å‡≤§‡≤µ‡≤æ‡≤ó‡≤ø‡≤∞‡≥Å‡≤µ ‡≤®‡≤®‡≥ç‡≤® ‡≤¨‡≤¶‡≥ç‡≤ß‡≤§‡≥Ü‡≤Ø‡≤®‡≥ç‡≤®‡≥Å ‡≤™‡≥ç‡≤∞‡≤§‡≤ø‡≤®‡≤ø‡≤ß‡≤ø‡≤∏‡≥Å‡≤§‡≥ç‡≤§‡≤¶‡≥Ü. ‡≤®‡≤æ‡≤®‡≥Å ‡≤™‡≥ç‡≤∞‡≤§‡≤ø‡≤¶‡≤ø‡≤® ‡≤π‡≤£‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤â‡≤§‡≥ç‡≤§‡≤Æ‡≤µ‡≤æ‡≤ó‡≤ø ‡≤®‡≤ø‡≤∞‡≥ç‡≤µ‡≤π‡≤ø‡≤∏‡≤≤‡≥Å ‡≤ï‡≤≤‡≤ø‡≤Ø‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥ç‡≤¶‡≥á‡≤®‡≥Ü ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤Æ‡≤æ‡≤∞‡≥ç‡≤ó‡≤¶‡≤∞‡≥ç‡≤∂‡≤® ‡≤®‡≤®‡≤ó‡≥Ü ‡≤¨‡≤π‡≤≥ ‡≤Æ‡≥Å‡≤ñ‡≥ç‡≤Ø. üòä">Thank you for taking the time to review my expenses. Every transaction here represents my commitment to being transparent and responsible. I'm learning to manage money better every day, and your guidance means the world to me. üòä</p>
      <p class="text-xs sm:text-sm text-green-700 font-medium mt-2" data-lang-en="- With love, Girish ‚ù§Ô∏è" data-lang-kn="- ‡≤™‡≥ç‡≤∞‡≥Ä‡≤§‡≤ø‡≤Ø‡≤ø‡≤Ç‡≤¶, ‡≤ó‡≤ø‡≤∞‡≥Ä‡≤∂‡≥ç ‚ù§Ô∏è">- With love, Girish ‚ù§Ô∏è</p>
    </div>
  </div>
</div>
{% endif %}

<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-3">
  <h1 class="text-xl sm:text-2xl font-semibold" data-lang-en="Dashboard - {{ year }} / {{ month }}" data-lang-kn="‡≤°‡≥ç‡≤Ø‡≤æ‡≤∂‡≥ç‚Äå‡≤¨‡≥ã‡≤∞‡≥ç‡≤°‡≥ç - {{ year }} / {{ month }}">Dashboard - {{ year }} / {{ month }}</h1>
  <div class="flex items-center space-x-2 sm:space-x-4">
    <form method="get" action="/" class="flex items-center space-x-2">
      <label for="month" class="text-sm" data-lang-en="Month:" data-lang-kn="‡≤§‡≤ø‡≤Ç‡≤ó‡≤≥‡≥Å:">Month:</label>
      <select id="month" name="month" class="border rounded p-1.5 text-sm min-w-[140px]">
        <option value="0" {% if month == 0 %}selected{% endif %}>All Time</option>
        <option value="1" {% if month == 1 %}selected{% endif %}>1 - January</option>
        <option value="2" {% if month == 2 %}selected{% endif %}>2 - February</option>
        <option value="3" {% if month == 3 %}selected{% endif %}>3 - March</option>
        <option value="4" {% if month == 4 %}selected{% endif %}>4 - April</option>
        <option value="5" {% if month == 5 %}selected{% endif %}>5 - May</option>
        <option value="6" {% if month == 6 %}selected{% endif %}>6 - June</option>
        <option value="7" {% if month == 7 %}selected{% endif %}>7 - July</option>
        <option value="8" {% if month == 8 %}selected{% endif %}>8 - August</option>
        <option value="9" {% if month == 9 %}selected{% endif %}>9 - September</option>
        <option value="10" {% if month == 10 %}selected{% endif %}>10 - October</option>
        <option value="11" {% if month == 11 %}selected{% endif %}>11 - November</option>
        <option value="12" {% if month == 12 %}selected{% endif %}>12 - December</option>
      </select>
      <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded text-sm" data-lang-en="Go" data-lang-kn="‡≤π‡≥ã‡≤ó‡≤ø">Go</button>
    </form>
  </div>
</div>

<div class="bg-blue-50 border border-blue-200 p-3 sm:p-4 rounded shadow mb-4">
  <h3 class="text-sm font-semibold mb-3" data-lang-en="Filter by Date Range" data-lang-kn="‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï ‡≤µ‡≥ç‡≤Ø‡≤æ‡≤™‡≥ç‡≤§‡≤ø‡≤Ø ‡≤Æ‡≥Ç‡≤≤‡≤ï ‡≤´‡≤ø‡≤≤‡≥ç‡≤ü‡≤∞‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø">Filter by Date Range</h3>
  <form method="get" action="/" class="space-y-3">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <div>
        <label for="filter_start" class="block text-sm font-medium mb-1" data-lang-en="From Date" data-lang-kn="‡≤á‡≤Ç‡≤¶ ‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï">From Date</label>
        <input type="date" id="filter_start" name="filter_start" value="{{ filter_start|date:'Y-m-d' }}" class="border rounded p-2.5 w-full text-base" style="min-height: 44px;">
      </div>
      <div>
        <label for="filter_end" class="block text-sm font-medium mb-1" data-lang-en="To Date" data-lang-kn="‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï‡≤¶‡≤µ‡≤∞‡≥Ü‡≤ó‡≥Ü">To Date</label>
        <input type="date" id="filter_end" name="filter_end" value="{{ filter_end|date:'Y-m-d' }}" class="border rounded p-2.5 w-full text-base" style="min-height: 44px;">
      </div>
    </div>
    <div class="flex flex-wrap gap-2">
      <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded font-medium text-sm flex-shrink-0" data-lang-en="Apply Filter" data-lang-kn="‡≤´‡≤ø‡≤≤‡≥ç‡≤ü‡≤∞‡≥ç ‡≤Ö‡≤®‡≥ç‡≤µ‡≤Ø‡≤ø‡≤∏‡≤ø">Apply Filter</button>
      <a href="/" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded font-medium text-sm inline-block text-center flex-shrink-0" data-lang-en="Clear" data-lang-kn="‡≤§‡≥Ü‡≤∞‡≤µ‡≥Å‡≤ó‡≥ä‡≤≥‡≤ø‡≤∏‡≤ø">Clear</a>
      <button type="button" onclick="setToday()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded text-sm flex-shrink-0" data-lang-en="Today" data-lang-kn="‡≤á‡≤Ç‡≤¶‡≥Å">Today</button>
      <button type="button" onclick="setThisWeek()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded text-sm flex-shrink-0" data-lang-en="This Week" data-lang-kn="‡≤à ‡≤µ‡≤æ‡≤∞">This Week</button>
      <button type="button" onclick="setThisMonth()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-2 rounded text-sm flex-shrink-0" data-lang-en="This Month" data-lang-kn="‡≤à ‡≤§‡≤ø‡≤Ç‡≤ó‡≤≥‡≥Å">This Month</button>
    </div>
  </form>
</div>

<script>
  function setToday() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('filter_start').value = today;
    document.getElementById('filter_end').value = today;
  }
  
  function setThisWeek() {
    const today = new Date();
    const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
    const lastDay = new Date(today.setDate(today.getDate() - today.getDay() + 6));
    document.getElementById('filter_start').value = firstDay.toISOString().split('T')[0];
    document.getElementById('filter_end').value = lastDay.toISOString().split('T')[0];
  }
  
  function setThisMonth() {
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    document.getElementById('filter_start').value = firstDay.toISOString().split('T')[0];
    document.getElementById('filter_end').value = lastDay.toISOString().split('T')[0];
  }
</script>

{% if messages %}
<div class="mb-4">
  {% for message in messages %}
  <div class="{% if 'success' in message.tags %}bg-green-100 border-green-400 text-green-700{% else %}bg-red-100 border-red-400 text-red-700{% endif %} border px-4 py-3 rounded">
    {{ message }}
  </div>
  {% endfor %}
</div>
{% endif %}

{% if user.is_staff %}
<div class="bg-white p-4 sm:p-6 rounded-lg shadow mb-4 sm:mb-6">
  <h2 class="text-lg sm:text-xl font-semibold mb-3 sm:mb-4" data-lang-en="Add New Expense" data-lang-kn="‡≤π‡≥ä‡≤∏ ‡≤ñ‡≤∞‡≥ç‡≤ö‡≥Å ‡≤∏‡≥á‡≤∞‡≤ø‡≤∏‡≤ø">Add New Expense</h2>
  <form method="post" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
    {% csrf_token %}
    <div>
      <label for="id_date" class="block text-sm font-medium mb-1" data-lang-en="Date" data-lang-kn="‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï">Date</label>
      {{ form.date }}
      {% if form.date.errors %}
        <p class="text-red-500 text-xs mt-1">{{ form.date.errors.0 }}</p>
      {% endif %}
    </div>
    <div>
      <label for="id_amount" class="block text-sm font-medium mb-1">Amount (‚Çπ)</label>
      {{ form.amount }}
      {% if form.amount.errors %}
        <p class="text-red-500 text-xs mt-1">{{ form.amount.errors.0 }}</p>
      {% endif %}
    </div>
    <div>
      <label for="id_category" class="block text-sm font-medium mb-1">Category</label>
      {{ form.category }}
      <datalist id="category-suggestions">
        <option value="Food">
        <option value="Transport">
        <option value="Groceries">
        <option value="Entertainment">
        <option value="Shopping">
        <option value="Bills">
        <option value="Health">
        <option value="Education">
        <option value="Others">
      </datalist>
      {% if form.category.errors %}
        <p class="text-red-500 text-xs mt-1">{{ form.category.errors.0 }}</p>
      {% endif %}
    </div>
    <div>
      <label for="id_description" class="block text-sm font-medium mb-1">Description</label>
      {{ form.description }}
      {% if form.description.errors %}
        <p class="text-red-500 text-xs mt-1">{{ form.description.errors.0 }}</p>
      {% endif %}
    </div>
    <div class="sm:col-span-2 lg:col-span-4">
      <button type="submit" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-medium py-2.5 px-6 rounded" data-lang-en="Add Expense" data-lang-kn="‡≤ñ‡≤∞‡≥ç‡≤ö‡≥Å ‡≤∏‡≥á‡≤∞‡≤ø‡≤∏‡≤ø">
        Add Expense
      </button>
    </div>
  </form>
</div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6">
  <div class="bg-white p-4 rounded-lg shadow">
    <div class="text-sm text-gray-600" data-lang-en="Total this period" data-lang-kn="‡≤à ‡≤Ö‡≤µ‡≤ß‡≤ø‡≤Ø ‡≤í‡≤ü‡≥ç‡≤ü‡≥Å">Total this period</div>
    <div class="text-2xl sm:text-3xl font-bold">‚Çπ{{ total_for_month }}</div>
  </div>
  <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm font-semibold" data-lang-en="Daily Totals" data-lang-kn="‡≤¶‡≥à‡≤®‡≤Ç‡≤¶‡≤ø‡≤® ‡≤í‡≤ü‡≥ç‡≤ü‡≥Å">Daily Totals</div>
      <div class="flex items-center space-x-2">
        {% if daily_date_range %}
        <span class="text-xs text-gray-600 mr-2">{{ daily_date_range }}</span>
        {% endif %}
        {% if daily_has_prev %}
        <a href="?year={{ year }}&month={{ month }}{% if filter_start %}&filter_start={{ filter_start|date:'Y-m-d' }}&filter_end={{ filter_end|date:'Y-m-d' }}{% endif %}&daily_page={{ daily_page|add:'-1' }}&expense_page={{ expense_page }}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-3 py-1.5 rounded shadow-sm transition-colors">‚Üê</a>
        {% else %}
        <span class="bg-gray-200 text-gray-400 font-bold px-3 py-1.5 rounded cursor-not-allowed">‚Üê</span>
        {% endif %}
        {% if daily_has_next %}
        <a href="?year={{ year }}&month={{ month }}{% if filter_start %}&filter_start={{ filter_start|date:'Y-m-d' }}&filter_end={{ filter_end|date:'Y-m-d' }}{% endif %}&daily_page={{ daily_page|add:'1' }}&expense_page={{ expense_page }}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-3 py-1.5 rounded shadow-sm transition-colors">‚Üí</a>
        {% else %}
        <span class="bg-gray-200 text-gray-400 font-bold px-3 py-1.5 rounded cursor-not-allowed">‚Üí</span>
        {% endif %}
      </div>
    </div>
    <div class="overflow-x-auto -mx-4 px-4">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left border-b">
            <th class="py-2 pr-4" data-lang-en="Date" data-lang-kn="‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï">Date</th>
            <th class="py-2">Total (‚Çπ)</th>
          </tr>
        </thead>
        <tbody>
          {% for d in daily_breakdown %}
          <tr class="border-b">
            <td class="py-2 pr-4">{{ d.date }}</td>
            <td class="py-2">{{ d.total }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="2" class="py-2 text-gray-500" data-lang-en="No expenses yet." data-lang-kn="‡≤á‡≤®‡≥ç‡≤®‡≥Ç ‡≤ñ‡≤∞‡≥ç‡≤ö‡≥Å‡≤ó‡≤≥‡≤ø‡≤≤‡≥ç‡≤≤.">No expenses yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<div class="bg-white p-3 sm:p-4 rounded-lg shadow">
  <div class="flex items-center justify-between mb-3">
    <div class="text-sm font-semibold" data-lang-en="All Expenses ({{ total_expenses_count }})" data-lang-kn="‡≤é‡≤≤‡≥ç‡≤≤‡≤æ ‡≤ñ‡≤∞‡≥ç‡≤ö‡≥Å‡≤ó‡≤≥‡≥Å ({{ total_expenses_count }})">All Expenses ({{ total_expenses_count }})</div>
    <div class="flex items-center space-x-2">
      {% if expense_date_range %}
      <span class="text-xs text-gray-600 mr-2">{{ expense_date_range }}</span>
      {% endif %}
      {% if expense_has_prev %}
      <a href="?year={{ year }}&month={{ month }}{% if filter_start %}&filter_start={{ filter_start|date:'Y-m-d' }}&filter_end={{ filter_end|date:'Y-m-d' }}{% endif %}&daily_page={{ daily_page }}&expense_page={{ expense_page|add:'-1' }}" class="bg-green-500 hover:bg-green-600 text-white font-bold px-3 py-1.5 rounded shadow-sm transition-colors">‚Üê</a>
      {% else %}
      <span class="bg-gray-200 text-gray-400 font-bold px-3 py-1.5 rounded cursor-not-allowed">‚Üê</span>
      {% endif %}
      {% if expense_has_next %}
      <a href="?year={{ year }}&month={{ month }}{% if filter_start %}&filter_start={{ filter_start|date:'Y-m-d' }}&filter_end={{ filter_end|date:'Y-m-d' }}{% endif %}&daily_page={{ daily_page }}&expense_page={{ expense_page|add:'1' }}" class="bg-green-500 hover:bg-green-600 text-white font-bold px-3 py-1.5 rounded shadow-sm transition-colors">‚Üí</a>
      {% else %}
      <span class="bg-gray-200 text-gray-400 font-bold px-3 py-1.5 rounded cursor-not-allowed">‚Üí</span>
      {% endif %}
    </div>
  </div>
  <div class="overflow-x-auto -mx-3 sm:-mx-4">
    <div class="inline-block min-w-full align-middle">
      <table class="min-w-full text-sm">
        <thead>
          <tr class="text-left border-b bg-gray-50">
            <th class="py-2 px-3 sm:px-2" data-lang-en="Date" data-lang-kn="‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï">Date</th>
            <th class="py-2 px-3 sm:px-2">Amount (‚Çπ)</th>
            <th class="py-2 px-3 sm:px-2">Category</th>
            <th class="py-2 px-3 sm:px-2 hidden sm:table-cell">Description</th>
            {% if user.is_staff %}
            <th class="py-2 px-3 sm:px-2" data-lang-en="Actions" data-lang-kn="‡≤ï‡≥ç‡≤∞‡≤ø‡≤Ø‡≥Ü‡≤ó‡≤≥‡≥Å">Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for e in expenses %}
          <tr class="border-b hover:bg-gray-50">
            <td class="py-2.5 px-3 sm:px-2 whitespace-nowrap text-xs sm:text-sm">{{ e.date|date:"M j" }}</td>
            <td class="py-2.5 px-3 sm:px-2 whitespace-nowrap font-medium">{{ e.amount }}</td>
            <td class="py-2.5 px-3 sm:px-2">
              <div class="max-w-[100px] sm:max-w-none truncate" title="{{ e.category }}">{{ e.category }}</div>
              <div class="sm:hidden text-xs text-gray-500 mt-1 truncate max-w-[150px]" title="{{ e.description }}">{{ e.description }}</div>
            </td>
            <td class="py-2.5 px-3 sm:px-2 hidden sm:table-cell">
              <div class="max-w-xs truncate" title="{{ e.description }}">{{ e.description }}</div>
            </td>
            {% if user.is_staff %}
            <td class="py-2.5 px-3 sm:px-2 whitespace-nowrap">
              <a href="{% url 'edit_expense' e.id %}" class="text-blue-600 hover:underline text-xs sm:text-sm inline-block mr-2 sm:mr-3" data-lang-en="Edit" data-lang-kn="‡≤∏‡≤Ç‡≤™‡≤æ‡≤¶‡≤ø‡≤∏‡≤ø">Edit</a>
              <a href="{% url 'delete_expense' e.id %}" class="text-red-600 hover:underline text-xs sm:text-sm inline-block" data-lang-en="Delete" data-lang-kn="‡≤Ö‡≤≥‡≤ø‡≤∏‡≤ø">Delete</a>
            </td>
            {% endif %}
          </tr>
          {% empty %}
          <tr><td colspan="{% if user.is_staff %}5{% else %}4{% endif %}" class="py-3 px-3 sm:px-2 text-gray-500 text-center" data-lang-en="No expenses for this period." data-lang-kn="‡≤à ‡≤Ö‡≤µ‡≤ß‡≤ø‡≤ó‡≥Ü ‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤ñ‡≤∞‡≥ç‡≤ö‡≥Å‡≤ó‡≤≥‡≤ø‡≤≤‡≥ç‡≤≤.">No expenses for this period.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
